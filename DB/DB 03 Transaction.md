# DB #3

### 트랜잭션(Transaction)

> 데이터베이스의 상태를 변화시키기 위해 수행하는 작업의 단위



데이터베이스의 상태를 변화시킨다?

=> SELECT, INSERT, UPDATE, DELETE와 같은 행위를 한다.



※ 트랜잭션 != **1개**의 SQL문

A가 B에게 계좌이체를 하는 상황

A의 계좌에서는 돈이 **이체**됨. (UPDATE)

B의 계좌에 돈이 **입금**됨. (UPDATE)

A의 통장과 B의 통장의 잔액은 변경된 금액이 **출력**됨.(SELECT)

=> 계좌이체의 트랜잭션은 SELECT, UPDATE로 구성됨.



### 트랜잭션의 특징

> 암기하세요. ACID

- 원자성(**A**tomicity)

  - `All or Nothing`

    트랜잭션은 전부 반영되거나 전부 반영되지 않아야 한다.

  - 돈을 보냈는데 상대방 통장에 돈이 입금되어 있지 않으면 끔찍하지.

  - **Rollback**

    > 현재 수행중인 트랜잭션에서 오류가 발생했을 때 현재 내역을 날려버리고 <u>임시 영역에 저장했던 상태</u>로 되돌리는 것.
    >
    > 임시 영역에 저장 -> save point를 지정한다.

    

- 일관성(**C**onsistency)

  - 트랜잭션이 성공적으로 완료됐을 때 데이터베이스는 일관성 있는 상태가 유지되어야 한다.

  - 돈은 데이터 타입이 정수형이지만 갑자기 문자열로 바뀌지 않는것.

  - 기본키, 외래키 등 변하지 않는것

  - **Commit**

    > 트랜잭션이 성공적으로 완료되어 일관성 있는 상태에 있을 때, 연산이 완료된 것을 알려주는 것.

    

- 독립성(**I**solation)

  - 하나의 트랜잭션이 진행중이면 다른 트랜잭션이 이를 방해할 수 없다.

  - 돈을 보내고 있는데 다른 사람이 갑자기 이체해서 내 돈이 안가면 가슴아프죠.

  - **Lock**

    > 트랜잭션 처리의 순차성을 보장해주는 기능.
    >
    > 하나의 트랜잭션이 완벽하게 끝날 때까지 다른 요청을 막아줌
    >
    > => 어떻게? 트랜잭션의 수행이 끝나면 unlock을 통해 다른 트랜잭션이 접근할 수 있도록 허용해줌.
    >
    > 
    >
    > Shared Lock
    >
    > - 데이터를 읽을 때 사용되는 Lock
    > - Shared Lock끼리는 동시 접근 가능
    >
    >
    > Exclusive Lock
    >
    > - 데이터를 변경할 때 사용되는 Lock
    >
    > - 데이터를 변경하고 있을 때, 다른 트랜잭션이 읽지도, 쓰지도 못하게 함.
    >
    >   읽기, 쓰기의 작업이 끝나면 unlock을 해줌으로 다른 트랜잭션이 lock을 걸면서 작업을 진행할 수 있도록 해줌.
    >
    > `Tip` 이게 잘못 사용되면 **교착상태(Deadlock)**에 빠질 수 있습니다.
    >
    > 교착상태 해결법
    >
    > 1. 하나의 트랜잭션을 강제 종료한다.
    > 2. 접근 순서 규칙을 정한다.

  

- 지속성(**D**urability)

  - 트랜잭션이 성공적으로 완료되면 그 상태는 영구적으로 반영된다.
  - 반영이 안되면 은행 서버가 고장났을 때, 잔액이 늘거나 줄거나 해서 혼란스럽죠.



### 트랜잭션의 상태

<img src="./DB 03 Transaction.assets/image-20220325235704728-16501659418371.png">

- Active
  - 트랜잭션 실행 중
- Partially Committed
  - 트랜잭션의 마지막 연산까지 실행됨. Commit 되기 직전
- Committed
  - 트랜잭션 완료. Commit 실행
- Failed
  - 트랜잭션이 실행되다 오류가 발생해서 중단된 상태
- Aborted
  - 트랜잭션이 비정상적으로 종료되어 Rollback이 실행된 상태



### 시스템 회복

> 트랜잭션의 논리적 오류가 발생했을 때 되돌리는 것 **Rollback**
>
> 시스템 오류 / 물리적 문제가 발생했을 때 되돌리는 것 **시스템 회복**

- 로그파일

  - 트랜잭션이 반영한 모든 데이터의 변경사항을 데이터베이스에 기록하기 전에 미리 기록해두는 별도의 데이터베이스

- Undo

  - 시작 O, Commit X
  - ctrl + z
  - 트랜잭션을 이전 상태로 되돌리는 것
  - 사용자가 했던 작업을 **<u>반대로</u>** 진행

- Redo

  - 시작 O, Commit O
  - 실패가 발생하기 전까지의 과정을 그대로 따라가는 것.
  - 사용자가 했던 작업을 <u>**그대로**</u> 진행

  <img src="./DB 03 Transaction.assets/image-20220326003114601.png">
  
  