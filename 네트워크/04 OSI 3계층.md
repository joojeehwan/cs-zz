# 04 3계층 IP

- 컴퓨터는 실제로 MAC(00:00:00:00:00)주소로 소통하지만, 사람들을 위해 IP(127.0.0.1) 주소를 사용한다. (도메인 = www.ssafy.com)

  <img src="04 OSI 3계층.assets/image-20220326190614090.png">

- 어차피 사람이 IP 주소를 사용하니, 컴퓨터도 IP 주소를 사용한다고 해도 무방하다.



## 3계층의 기능

### 3계층의 역할

- 서로 다른 LAN과 LAN을 연결시켜주는것
- 다른 네트워크 대역 즉, **멀리 떨어진 곳**에 존재하는 네트워크까지 어떻게 데이터를 전달할지 제어하는 일을 담당
- `라우터` (발신에서 착신까지의 패킷의 경로를 제어)와 같은 3계층 장비가 필요하다. 



### 3계층에서 쓰는 주소

- 멀리 있는 네트워크와 통신하려면 MAC주소 뿐만 아니라 **IP주소**도 필요하다.
- WAN에서 통신할 때 사용하는 IP 주소
  - 이때 IP주소만 있는게 아니라 추가적으로 서브넷 마스크, 게이트웨이 주소가 추가적으로 필요하다. 

<img src="04 OSI 3계층.assets/image-20220318082120594.png">

- IP주소로 통신한다고 했지만 사실은 domain주소로 접속하는데, domain 주소로 접속해도 ip주소로 바꿔주는 것은 추후에 배움(DNS)





### :star:3계층 프로토콜 (=ARP, IPv4, ICMP)

- ARP : IP 주소를 이용해 MAC 주소를 알아오는 프로토콜
- IPv4 : WAN에서 통신할 때 사용하는 프로토콜
  - IPv6로 넘어가자고 얘기가 나온지 오래지만 아직도...
  - Header에 있는 Version을 6으로 바꾼다고 IPv6가 되지 않음. 애초에 헤더가 생긴게 다름
  - IPv6는 IPv4처럼 생긴 주소를 아예 쓰지 않음
- ICMP : 서로가 통신 되는지 확인할 때 사용하는 프로토콜





## 일반적인 IP 주소

- 통상적으로 IPv4를 의미한다.

### Classful

<img src="04 OSI 3계층.assets/image-20220318083212078.png">

- 처음엔 클래스를 나눠 사용했고, 이 형태는 낭비가 심하다.
  - 클래스가 각각 무엇인지 알 필요가 없다.
  - 이진수로 나누는 방법
    - `0.0.0.0` = `00000000.00000000.000000000.00000000`
    - `255.255.255.255` = `111111111.11111111.111111111.11111111`
    - A 클래스는 `00000000.00000000.000000000.00000000` ~ `01111111.11111111.111111111.11111111`
    - B 클래스는 `10000000.00000000.000000000.00000000` ~ `10111111.11111111.111111111.11111111`
    - C 클래스는 `11000000.00000000.000000000.00000000` ~ `11011111.11111111.111111111.11111111`
    - D 클래스는 `11100000.00000000.000000000.00000000` ~ `11101111.11111111.111111111.11111111`
    - E 클래스는 `11110000.00000000.000000000.00000000` ~ `11111111.11111111.111111111.11111111`
  - MAC주소는 16진수 6byte, IP주소는 10진수 4byte
    - 1byte는 8bit, 8bit가 표현할 수 있는 숫자의 개수는 256개 (0~255)
    - 사람이 알아보기 쉽게 10진수로 설정했다보니 255까지밖에 쓸 수 없는 것
  - 클래스를 나눴던 이유는
    - A 클래스는 네트워크 대역을 나누기 위해서
      - A클래스도 여러개가 있을 수 있다. 
      - 맨 앞의 숫자로만 구분, 총 128개 (0 ~ 127)
      - 그 안에 속한 컴퓨터는 뒤의 3개 숫자로 구분한다. 2 ** 24
        - 하나의 네트워크 대역 안에서 167777216개 구분 가능
      - A클래스는 엄청나게 큰 규모의 기관에서 사용하는 경우
    - B 클래스는 네트워크 대역을 앞의 숫자 2개로 구분한다.
      - 네트워크 대역 구분  : `0.0`.0.0
      - PC 구분: 0.0.`0.0` => 65536개
    - C 클래스는 네트워크 대역을 3번째 필드 까지 사용하여 구분한다.
      - 네트워크 대역 구분 : `0.0.0`.0
      - PC 구분: 0.0.0.`0` => 256개
      - 일반적으로 많이 사용하는 클래스
    - D 클래스는 멀티캐스트를 위해 남겨둔 주소 (일반 PC가 사용X)
    - E 클래스는 실험용으로 예약해둔 주소
- 발생할 수 있는 문제
  - 만약 A클래스를 일반 강의장에서 사용했다면??
  - 1600만개의 컴퓨터를 연결할 일이 없다. 낭비가 된다. 낭비되는게 많아서 IP주소가 부족하다.
  - 그럼..? 클래스에 딱 맞지 않게 쓰자 = Classless



### Classless

- 하나의 큰 네트워크를 작은 네트워크로 나눠서 사용하자

- 낭비되지 않도록 아껴쓰는 IP 주소
  - 원래는 `0.0.0.0` 에서 `.` 을 기준으로만 구분했는데, 이젠 그 안에서 `.`에 구애받지 않고 나눔

- 서브넷 마스크
  - 네트워크 대역을 어디서부터 구분할건지 지정한 값

  - IP주소는 항상 서브넷 마스크와 같이 쓴다

  - 어떻게 첫번째, 두번째 필드가 아닌 **중간** 지점에서 나눌 수 있을까??
    - `00000000`.~ 를 `000` `00000`.~ 처럼 나눌 수 있는걸까?

  - 특징

    - 클래스풀한 네트워크 대역을 나눠주는데 사용하는 값

    - 2진수로 표기했을 때 1로 시작. 1과 1사이에는 0이 올 수 없다는 규칙을 가지고 있다.

    - **1하고 0 이 바뀌는 그 부분**

      <img src="04 OSI 3계층.assets/image-20220318182148684.png">

    - 어디까지가 네트워크 대역을 구분하는데 사용하고 어디서부터 호스트를 구분하는데 사용하는지 지정

    - 255.255.255.192 (32bit = 4byte)와 같은 주소는 `11111111.11111111.11111111.11000000`

하지만 그럼에도 불구하고 IP는 부족하다... 그렇지만 IPv6로 바꾸기도 어렵고..

이 때문에 사설 IP와 공인 IP를 나눈다.



### :star:사설IP와 공인IP 

Classless와 사설, 공인 IP를 함께 쓴다.

<img src="04 OSI 3계층.assets/image-20220318182606282.png">

- 공인 IP = 인터넷 세상. 실제로 네트워크 통신망이랑 통신할 때 사용하는 IP주소
- 사설 IP = 같은 네트워크 대역에서 사용하는 IP 주소
- 강의장에선 전부 사설 IP를 쓰고, 다른 네트워크(네이버)로 갈 때 공인 IP주소 작성
  - 네이버에 '내 ip 주소'를 치면  `123.141.75.162`이 나온다. = 공인 IP
  - 하지만 cmd로 출력하면 `192.168.0.100` 이 된다. = 사설 IP
- 인터넷의 리소스는 공유기가 받아오고, 공유기가 요청을 보낸 단말기에게 전달해준다.
- 네트워크 주소를, 사설 -> 공인으로 바꿔주는 것을 NAT(Network Address Translation)이라고 한다.
  - 정확히는 사설을 공인으로 바꾸는 것만 의미하는게 아니라, ip 주소를 변환해주는 것을 의미한다.
  - 사설 -> 사설, 공인 -> 공인으로도 가능
  - 이 기술을 통해 IP 부족현상을 해결하기 위함
  - 같은 네트워크 대역은 사설 IP를 사용하고, 다른 네트워크와 통신할 때 공인 IP를 사용
- 집에 여러개의 단말기가 있다고 하자. 하지만 인터넷은 하나만 신청하지 않는가?
  - 이건 공인 IP를 하나를 사는 셈이다. 그리고 그 IP를 같은 네트워크에 있는 단말기들이 모두 사용하는 것.
  - 같은 네트워크 대역에 있는 ip는 요즘에 전부 사설 ip를 사용
  - 옛날에 공유기라는게 나오기 전에는 매번 공인ip를 새로 신청했어야한다.



<img src="04 OSI 3계층.assets/image-20220318183151498.png">

- 외부에서 볼땐, 사설 IP를 볼 수 없다.
- 실제 인터넷 세상에선 공인 IP로만 통신하기 때문이다.

<img src="04 OSI 3계층.assets/image-20220318183219904.png">

- 같은 공인 IP를 사용하는데도 각자 인터넷을 사용할 수 있는 이유는, 요청이 밖으로 나갈 때 기록을 하고
  - NAT 테이블이란 표에 기록
  - 이것에 대한 응답이 왔을 떄 이 표를 보고 대상한테 전달해준다.
- 만약에, 나갈때 NAT 에 기록한다고 했죠. 만약에 나간 적이 없는데 응답이 들어오면????
  - 어딘가에서 갑자기 우리 공유기한테 뭔갈 보냈어요.
  - 그럼 그냥 공유기가 받고 끝남. 자기가 가짐. 전달해주지 않음
- 이게 무슨소리냐, 내부에 특정 웹 서버가 있다고 할게요
- 네이버가 사설 네트워크 대역에 있다. 우리가 먼저 네이버에 요청 보냄
- 근데 사설 네트워크 내부는 보이지 않으므로 공유기에게 보내야함
- 하지만 공유기가 받은 그 요청은, 네이버가 밖에 요청한적이 없는 것이라서 네이버가 받을 수 없다.
- 그래서 일반적으로 서버는 사설 ip를 잘 안쓴다. 서버 자체는 공인 ip 사용
- 아니면 공유기에 추가적으로 설정= 포트 포워딩
  - 하지만 port 번호는 4계층(TCP)에서 사용하는 것. 나중에 배운다.
- 사설IP는 외부에서 볼 수 없기 때문에 무조건 나갔다 들어오는 것만 통신이 되지, 바깥에서 바로 안쪽으로 들어올 수 없다. 포트 포워딩을 해주지 않는 이상
- 공인 IP 한개당 사설 IP 네트워크 대역이 새로 생기는 것이기 때문에 2^32개(= 256`*`256`*`256`*`256)의 사설 IP 사용 가능
- IPv4 -> IPv6 가는 방법 (네트워크 엔지니어 하려면  IPv6 공부해야됨)



## 특수한 IP주소

### 0.0.0.0 = wildcard

- **나머지** 모든 IP
- 일반적이지 않음



### 127.X.X.X

- 127.0.0.1 : **자기 자신**을 뜻하는 주소, 자신의 컴퓨터를 뜻하는 것



### 게이트웨이 주소

일반적으로 공유기의 ip

<img src="04 OSI 3계층.assets/image-20220318184420649.png">

<img src="04 OSI 3계층.assets/image-20220318184622672.png">

- WAN은 외부 네트워크 연결, 공인 IP 할당
- 그 외의 1,2,3,4는 각각 연결된 장비들이 사설 ip를 할당받는다.
- 게이트웨이는 보통 네트워크 대역에서 쓸 수 있는 ip중 가장 크거나 가장 작은걸 사용하기로함. 보통은 작은거
- 네트워크 장비들이 통신할 때 무조건 공유기를 통해서 나가게 되어있는데, 걔를 건너뛰고 연결이 될 수 없으니까.
- 무조건 공유기를 통해서 나갈 수 있으므로 외부 세상과 통하는 문인데 저 문이 gateway이다. 기본 문짝!!
- 게이트웨이 설정을 안해도 내 컴퓨터 IP 설정은 되는데 나가는 곳이 어딘지 몰라서 인터넷이 안됨
- IP주소를 설정할땐 최소한 IP주소, 서브넷 마스크, 기본 게이트웨이가 있어야 '인터넷'이라는걸 사용할 수 있다.

<img src="04 OSI 3계층.assets/image-20220318185742213.png">





### 지난번 질문

Q. TCP 헤더에는 이더넷 타입이 없는데 어떻게 다음 단계를 알 수 있는지?

<img src="04 OSI 3계층.assets/header-data-offset.png">

A. 현재 네트워크는 TCP/IP 네트워크 모델을 사용하므로 TCP 다음에는 데이터가 온다는 것이 일반적이다. 그에 따라 이더넷 타입 대신 `Data offset` 이라는 필드가 존재하며 Data가 어디서부터 시작하는지 알 수 있어서 데이터를 읽는다.

<img src="04 OSI 3계층.assets/ip헤더.png">

IP도(네트워크 계층) 헤더에 `Protocol Identifier ` 가 존재하며 상위 계층의 프로토콜을 알 수 있다.
